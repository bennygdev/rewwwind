{% extends "views/base.html" %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tradein/custTradeDetails.css') }}">
{% endblock %}

{% block content %}
<div class="trade-details-container">
    <div class="trade-details-header">
        <h1>Trade-in Request #{{ "%03d"|format(trade_item.id) }}</h1>
        <span class="status {{ trade_item.status.lower().replace(',', '').replace(' ', '-') }}">
            {{ trade_item.status }}
        </span>
    </div>

    <div class="trade-details-info">
        <div class="info-box">
            <p>Estimated Review</p>
            <span>{{ (trade_item.created_at + timedelta(days=3)).strftime('%d %b %Y') }}</span>
        </div>
        <div class="info-box">
            <p>Delivery Method</p>
            <span>{{ "Drop-off" if trade_item.item_condition in ["Brand New", "Like New"] else "Pick-up" }}</span>
        </div>
    </div>

    <div class="items-section">
        <h2>Items</h2>
        <div class="item-details">
            <div class="item-image">
                <p>No Image Available</p>
            </div>
            <div class="item-info">
                <p><strong>Title:</strong> {{ trade_item.title }}</p>
                <p><strong>Item Type:</strong> {{ trade_item.item_type }}</p>
                <p><strong>Genre:</strong> {{ trade_item.genre }}</p>
                <p><strong>Author:</strong> {{ trade_item.author_artist }}</p>
                <p><strong>ISBN:</strong> {{ trade_item.isbn_or_cat }}</p>
                <p><strong>Condition:</strong> {{ trade_item.item_condition }}</p>
            </div>
        </div>
    </div>

    <!-- Admin Approve/Deny Buttons -->
    {% if current_user.role_id in [2, 3] and trade_item.status == "Pending" %}
    <div class="admin-actions">
        <a href="{{ url_for('manageTradeins.update_trade_status', trade_id=trade_item.id, status='Approved') }}" 
            class="btn btn-success">Approve</a>
        <a href="{{ url_for('manageTradeins.update_trade_status', trade_id=trade_item.id, status='Rejected') }}" 
            class="btn btn-danger">Reject</a>
    </div>
    {% endif %}

    {% if trade_item.status in ["Approved", "APPROVED, PENDING DELIVERY"] %}
        <div class="shipping-payment-section">
            <h2>Shipping & Payment</h2>

            {% if trade_item.shipping_option %}
                <div class="submitted-details">
                    <h3>Shipping Option</h3>
                    <p>{{ trade_item.shipping_option }}</p>

                    {% if trade_item.shipping_option == "Mail-in" %}
                        <h3>Tracking Number</h3>
                        <p>{{ trade_item.tracking_number }}</p>
                    {% elif trade_item.shipping_option == "Pick-Up Service" %}
                        <h3>Shipping Address</h3>
                        <p>{{ trade_item.street_address }}, {{ trade_item.house_block }}, {{ trade_item.zip_code }}</p>
                        <p>Contact: {{ trade_item.contact_number }}</p>
                    {% endif %}

                    <h3>Payment Option</h3>
                    <p>Card Ending: ****{{ trade_item.card_number[-4:] }}</p>
                    <p>Exp: {{ trade_item.card_expiry }}</p>
                    <p>Name on Card: {{ trade_item.card_name }}</p>
                </div>
            {% else %}
                {% if current_user.role_id not in [2, 3] %}
                <!-- Shipping Form (Only for Customers) -->
                <form action="{{ url_for('manageTradeins.save_shipping_payment', trade_id=trade_item.id) }}" method="POST">
                    {{ form.hidden_tag() }}

                    <h3>Shipping Option</h3>
                    <div class="radio-group">
                        {% for subfield in form.shipping_option %}
                            <label>
                                {{ subfield }} {{ subfield.label.text }}
                            </label>
                        {% endfor %}
                    </div>

                    <div id="tracking-number-section" class="hidden">
                        <h3>Tracking Number</h3>
                        {{ form.tracking_number(class="form-control", placeholder="Enter Tracking Number") }}
                    </div>

                    <div id="shipping-address-section" class="hidden">
                        <h3>Shipping Address</h3>
                        {{ form.street_address(class="form-control", placeholder="Street Address") }}
                        {{ form.house_block(class="form-control", placeholder="House / Block No.") }}
                        {{ form.zip_code(class="form-control", placeholder="Zip or Postal Code") }}
                        {{ form.contact_number(class="form-control", placeholder="Contact Number") }}
                    </div>

                    <h3>Payment Option</h3>
                    <div id="payment-section">
                        {{ form.card_number(class="form-control", placeholder="Card Number") }}
                        {{ form.card_expiry(class="form-control", placeholder="Expiration Date (MM/YY)") }}
                        {{ form.card_name(class="form-control", placeholder="Name on Card") }}
                    </div>

                    <button type="submit" class="btn btn-success">Submit</button>
                </form>
                {% else %}
                <p class="admin-shipping-info">Waiting for customer to submit shipping details.</p>
                {% endif %}
            {% endif %}
        </div>
    {% endif %}

    <a href="{{ url_for('manageTradeins.manage_tradeins') }}" class="btn btn-secondary">Back to Dashboard</a>
</div>

{% block scripts %}
<script src="{{ url_for('static', filename='js/tradein/tradeDetails.js') }}"></script>
{% endblock %}

{% endblock %}
