{% extends "views/base.html" %}
{% set active_page = "products" %}
{% block styles %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/pageInteractions/multiFilter.css') }}">
<link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='css/views/productPagination.css') }}">
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/pageInteractions/filters.css') }}">
{% endblock %}
{% block title %}Products{% endblock %}
{% block content %}
<div class="listing__header">
  <!-- Preserve current filter values -->
  {% if category_filter %}
  <input type="hidden" name="category" value="{{ category_filter }}">
  {% endif %}
  {% if subcategory_filter %}
  <input type="hidden" name="subcategory" value="{{ subcategory_filter }}">
  {% endif %}
  {% if status_filter %}
  <input type="hidden" name="status" value="{{ status_filter }}">
  {% endif %}
  <div class="header__left">
      <h1>{% block h1 %}Products{% endblock %}</h1>
      {% if products.items %}
      <p>Showing <span class="productPerPage">{{ 16 * current_page - 15 }}</span> &minus; <span class="productPerPage">{{ 16 * current_page if 16 * current_page < total_products else total_products  }}</span> of {{ total_products }} results</p>
      {% endif %}
  </div>
  <div class="header__right">
    <form id="filterForm" method="get" action="{{ url_for('productPagination.product_pagination') }}" class="filters__form">
      <!-- Preserve search query if exists -->
      {% if search_query %}
      <input type="hidden" name="q" value="{{ search_query }}">
      {% endif %}
      
      <div class="filter__group">
          <label for="type">Type</label>
          <select name="type" id="type" class="filter__select">
              <option value="">All</option>
              {% for value, label in category_choices %}
              <option value="{{ value }}" {% if category_filter == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
          </select>
      </div>

      <div class="filter__group">
        <label for="genre">Genre</label>
        <select name="genre[]" id="genre" class="filter__select" multiple>
            <option value="or{% if 'or' in match_req %}@{% endif %}" {% if 'or' in match_req %}selected 1{% endif %}>Match Any</option>
            {% if subcategory_filter %}
            <option value="and{% if 'and' in match_req %}@{% endif %}" {% if 'and' in match_req %}selected 1{% endif %}>Match All</option>
            {% endif %}
            {% for value, label in subcategory_choices %}
            <option value="{{ value }}" {% if value in subcategory_filter %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
        </select>
      </div>
  
      <div class="filter__group">
          <label for="price">Price</label>
          <select name="price" id="price" class="filter__select">
              <option value="">All</option>
              {% for value, label in price_choices %}
              <option value="{{ value }}" {% if price_filter == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
          </select>
      </div>

      <div class="filter__group">
          <label for="rating">Rating</label>
          <select name="rating" id="rating" class="filter__select">
              <option value="">All</option>
              {% for value, label in rating_choices %}
              <option value="{{ value }}" {% if rating_filter == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
          </select>
      </div>
      
      {% if category_filter or subcategory_filter or price_filter or rating_filter %}
      <div class="filter__group">
      <a href="{{ url_for('productPagination.product_pagination', q=search_query) }}" class="clear__filters">Clear Filters</a>
      {% endif %}
      </div>
  </form>
  </div>
</div>
{% if products.items %}
<div class="products">
  {% for product in products %}
  <div class="product">
    <a href="{{ url_for('productPagination.product_detail', product_id = product.id) }}">
      <div class="thumbnail">
        <div class="rating">
          {% if product.reviews %}
            {% set rating = product.rating %}
          {% else %}
            {% set rating = "No rating yet" %}
          {% endif %}
          <span><i class="bi bi-star-fill"></i>&nbsp;{{ rating }}</span>
        </div>
        <div class="image">
          <img src="{{ url_for('static', filename='media/uploads/' + product.image_thumbnail) }}" alt="{{ product.name }}"/>
          <!-- <img src="https://res.cloudinary.com/dyduc8kjz/image/upload/v1738220526/{{ product.image_thumbnail }}" alt="{{ product.name }}"/> -->
        </div>
        <!-- <a href="{{ url_for('addToCart.add_to_cart', product_id=product.id)}}"> -->
        <!-- </a> -->
        {% if current_user.role_id == 1 %}
        <div class="favourites" title="{% if current_user.wishlisted_items and product.id in current_user.wishlisted_items %}Remove from Favourites{% else %}Add to Favourites{% endif %}">
          <form action="{{ url_for('wishlist.remove_favourite', product_id=product.id) if current_user.wishlisted_items and product.id in current_user.wishlisted_items else url_for('wishlist.add_favourite', product_id=product.id) }}" method="POST" class="cta-form">
            {{ form.hidden_tag() }}
            {{ form.condition() }}
            <button type="submit">
              <div class="heart-container">
                <i class="bi bi-heart fa-xl"></i>
                <i class="bi bi-heart-fill fa-xl {% if current_user.wishlisted_items and product.id in current_user.wishlisted_items %}fav{% endif %}"></i>
              </div>
            </button>
          </form>
        </div>
        {% endif %}
        <div class="cart" title="Add Product to Cart">
          <form action="{{ url_for('addToCart.add_to_cart', product_id=product.id) }}" method="POST" class="cta-form">
            {{ form.hidden_tag() }}
            {{ form.condition() }}
            <button type="submit"><i class="fa-solid fa-cart-shopping fa-xl"></i></button>
          </form>
        </div>
      </div>
    </a>
    <div class="info">
      <div class="info_left">
        <h5 class="name">{{ product.name }}</h5>
        <span>{{ product.creator }}</span>
      </div>
      <div class="info_right">
        <h5>&dollar;{{ '{:.2f}'.format(product.conditions[0].price) }}</h5>
        <span><i class="bi bi-short-fill"></i>&nbsp;{{ product.category.category_name }}</span>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
<div class="products__pagination">
  <ul>
      {% if current_page > 1 %}
          <li class="pagePrevious__button">
            <a href="{{ url_for('productPagination.product_pagination', page=current_page-1, q=search_query if search_query else None, category=category_filter if category_filter else None, subcategory=subcategory_filter if subcategory_filter else None, price=price_filter if price_filter else None, rating=rating_filter if rating_filter else None) }}">
            Previous
            </a>
          </li>
      {% endif %}
      {% for p in range(1, total_pages + 1) %}
          <li class="{% if p == current_page %}active{% endif %}">
            <a class="page__button" href="{{ url_for('productPagination.product_pagination', page=p, q=search_query if search_query else None, category=category_filter if category_filter else None, subcategory=subcategory_filter if subcategory_filter else None, price=price_filter if price_filter else None, rating=rating_filter if rating_filter else None) }}">
            {{ p }}
            </a>
          </li>
      {% endfor %}
      {% if current_page < total_pages %}
          <li class="pageNext__button">
            <a href="{{ url_for('productPagination.product_pagination', page=current_page+1, q=search_query if search_query else None, category=category_filter if category_filter else None, subcategory=subcategory_filter if subcategory_filter else None, price=price_filter if price_filter else None, rating=rating_filter if rating_filter else None) }}">
            Next
            </a>
          </li>
      {% endif %}
  </ul>
</div>
{% else %}
<h2 class="none">Sorry, no products were found with the given search queries and/or filters.</h2>
{% endif %}
{% endblock %}

{% block body_scripts %}
<script type="text/javascript" src="{{ url_for('static', filename='js/dashboardFilters.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/pageInteractions/multiFilter.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/productPagination/productPagination.js') }}"></script>
{% endblock %}